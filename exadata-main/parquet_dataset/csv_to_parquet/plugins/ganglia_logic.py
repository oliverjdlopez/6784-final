import pyarrow as pa
import pyarrow.compute as pc
import pandas as pd
from plugins.plugin_logic import PluginLogic

class GangliaLogic(PluginLogic):
    def __init__(self):
        super().__init__()

        self.data_path = '/nas/cinecadataset/Comp_2/ganglia_pub'

        self.sel_cols = ['plugin', 'name', 'timestamp', 'value', 'node']

        self.value_type_per_metric = {'Gpu2_fb_used': pa.int32(),
                                      'Gpu3_power_management_limit': pa.int32(),
                                      'Gpu1_ecc_sbe_aggregate_total': pa.int32(),
                                      'Gpu3_gpu_utilization': pa.int32(),
                                      'Gpu3_sm_app_clock': pa.int32(),
                                      'Gpu1_retired_pages_sbe': pa.int32(),
                                      'Gpu0_power_usage': pa.float32(),
                                      'cpu_wio': pa.float32(),
                                      'Gpu0_board_limit_violation': pa.int32(),
                                      'Gpu2_retired_pages_pending': pa.int32(),
                                      'Gpu1_total_energy_consumption': pa.float64(),
                                      'Gpu2_reliability_violation': pa.int32(),
                                      'Gpu1_nvlink_replay_error_count_total': pa.int32(),
                                      'Gpu0_ecc_sbe_volatile_total': pa.int32(),
                                      'Gpu0_gpu_temp': pa.int32(),
                                      'machine_type': pa.string(),
                                      'disk_free': pa.float32(),
                                      'Gpu3_gpu_temp': pa.int32(),
                                      'Gpu1_fb_total': pa.int32(),
                                      'Gpu0_nvlink_flit_crc_error_count_total': pa.int32(),
                                      'Gpu2_current_clock_throttle_reasons': pa.int32(),
                                      'Gpu1_board_limit_violation': pa.int32(),
                                      'Gpu0_nvlink_bandwidth_total': pa.int32(),
                                      'Gpu0_reliability_violation': pa.int32(),
                                      'Gpu0_retired_pages_sbe': pa.int32(),
                                      'Gpu3_mem_copy_utilization': pa.int32(),
                                      'Gpu3_pstate': pa.int32(),
                                      'Gpu2_board_limit_violation': pa.int32(),
                                      'Gpu0_current_clock_throttle_reasons': pa.int32(),
                                      'Gpu0_sm_clock': pa.int32(),
                                      'Gpu3_low_util_violation': pa.int32(),
                                      'Gpu3_nvlink_recovery_error_count_total': pa.int32(),
                                      'Gpu2_mem_app_clock': pa.int32(),
                                      'Gpu1_gpu_util_samples': pa.int32(),
                                      'Gpu2_nvlink_bandwidth_total': pa.int32(),
                                      'Gpu1_pstate': pa.int32(),
                                      'mem_buffers': pa.int32(),
                                      'Gpu3_nvlink_bandwidth_total': pa.int32(),
                                      'Gpu1_retired_pages_dbe': pa.int32(),
                                      'Gpu1_nvlink_recovery_error_count_total': pa.int32(),
                                      'Gpu0_total_energy_consumption': pa.float64(),
                                      'proc_run': pa.int32(),
                                      'Gpu2_low_util_violation': pa.int32(),
                                      'Gpu2_ecc_sbe_aggregate_total': pa.int32(),
                                      'mem_total': pa.float64(),
                                      'Gpu1_memory_temp': pa.int32(),
                                      'Gpu0_mem_app_clock': pa.int32(),
                                      'Gpu3_nvlink_flit_crc_error_count_total': pa.int32(),
                                      'Gpu1_current_clock_throttle_reasons': pa.int32(),
                                      'bytes_in': pa.float32(),
                                      'Gpu1_nvlink_flit_crc_error_count_total': pa.int32(),
                                      'Gpu2_sync_boost_violation': pa.int32(),
                                      'Gpu2_ecc_dbe_aggregate_total': pa.int32(),
                                      'cpu_steal': pa.int32(),
                                      'Gpu1_fb_free': pa.int32(),
                                      'proc_total': pa.int32(),
                                      'Gpu1_ecc_sbe_volatile_total': pa.int32(),
                                      'Gpu0_ecc_sbe_aggregate_total': pa.int32(),
                                      'Gpu1_gpu_utilization': pa.int32(),
                                      'Gpu1_power_violation': pa.int32(),
                                      'Gpu0_ecc_dbe_aggregate_total': pa.int32(),
                                      'Gpu0_nvlink_recovery_error_count_total': pa.int32(),
                                      'Gpu3_gpu_util_samples': pa.int32(),
                                      'Gpu2_nvlink_recovery_error_count_total': pa.int32(),
                                      'Gpu1_memory_clock': pa.int32(),
                                      'Gpu0_xid_errors': pa.int32(),
                                      'Gpu1_gpu_temp': pa.int32(),
                                      'Gpu0_retired_pages_dbe': pa.int32(),
                                      'Gpu3_fb_used': pa.int32(),
                                      'Gpu3_memory_temp': pa.int32(),
                                      'Gpu1_mem_app_clock': pa.int32(),
                                      'Gpu2_mem_copy_utilization': pa.int32(),
                                      'Gpu0_memory_clock': pa.int32(),
                                      'Gpu0_sync_boost_violation': pa.int32(),
                                      'Gpu3_board_limit_violation': pa.int32(),
                                      'Gpu1_ecc_dbe_aggregate_total': pa.int32(),
                                      'cpu_speed': pa.int32(),
                                      'Gpu0_memory_temp': pa.int32(),
                                      'Gpu3_power_usage': pa.float32(),
                                      'Gpu3_thermal_violation': pa.int32(),
                                      'Gpu0_fb_free': pa.int32(),
                                      'Gpu0_gpu_util_samples': pa.int32(),
                                      'mem_shared': pa.int32(),
                                      'Gpu0_fb_total': pa.int32(),
                                      'Gpu3_current_clock_throttle_reasons': pa.int32(),
                                      'Gpu1_nvlink_bandwidth_total': pa.int32(),
                                      'Gpu0_sm_app_clock': pa.int32(),
                                      'Gpu1_fb_used': pa.int32(),
                                      'Gpu2_nvlink_replay_error_count_total': pa.int32(),
                                      'Gpu3_ecc_sbe_volatile_total': pa.int32(),
                                      'gexec': pa.string(),
                                      'Gpu1_mem_copy_utilization': pa.int32(),
                                      'Gpu3_ecc_sbe_aggregate_total': pa.int32(),
                                      'cpu_idle': pa.float32(),
                                      'Gpu2_retired_pages_dbe': pa.int32(),
                                      'Gpu2_total_energy_consumption': pa.float64(),
                                      'Gpu1_sm_clock': pa.int32(),
                                      'os_name': pa.string(),
                                      'Gpu3_retired_pages_sbe': pa.int32(),
                                      'Gpu2_power_violation': pa.int32(),
                                      'cpu_num': pa.int32(),
                                      'cpu_system': pa.float32(),
                                      'Gpu0_retired_pages_pending': pa.int32(),
                                      'load_five': pa.float32(),
                                      'Gpu1_nvlink_data_crc_error_count_total': pa.int32(),
                                      'Gpu1_low_util_violation': pa.int32(),
                                      'Gpu2_gpu_utilization': pa.int32(),
                                      'Gpu2_ecc_dbe_volatile_total': pa.int32(),
                                      'boottime': pa.float64(),
                                      'disk_total': pa.float32(),
                                      'Gpu2_power_usage': pa.float32(),
                                      'swap_total': pa.int32(),
                                      'Gpu3_nvlink_data_crc_error_count_total': pa.int32(),
                                      'Gpu0_gpu_utilization': pa.int32(),
                                      'Gpu3_fb_free': pa.int32(),
                                      'Gpu0_fb_used': pa.int32(),
                                      'Gpu2_xid_errors': pa.int32(),
                                      'Gpu1_ecc_dbe_volatile_total': pa.int32(),
                                      'cpu_aidle': pa.float32(),
                                      'mem_free': pa.float64(),
                                      'Gpu2_memory_clock': pa.int32(),
                                      'Gpu3_xid_errors': pa.int32(),
                                      'mem_cached': pa.float64(),
                                      'Gpu2_nvlink_data_crc_error_count_total': pa.int32(),
                                      'Gpu2_sm_clock': pa.int32(),
                                      'Gpu3_mem_app_clock': pa.int32(),
                                      'part_max_used': pa.float32(),
                                      'Gpu1_power_management_limit': pa.int32(),
                                      'Gpu3_sm_clock': pa.int32(),
                                      'Gpu3_retired_pages_pending': pa.int32(),
                                      'Gpu2_pstate': pa.int32(),
                                      'Gpu1_thermal_violation': pa.int32(),
                                      'os_release': pa.string(),
                                      'Gpu2_power_management_limit': pa.int32(),
                                      'Gpu0_low_util_violation': pa.int32(),
                                      'Gpu1_xid_errors': pa.int32(),
                                      'Gpu2_sm_app_clock': pa.int32(),
                                      'Gpu3_memory_clock': pa.int32(),
                                      'Gpu2_fb_total': pa.int32(),
                                      'Gpu1_reliability_violation': pa.int32(),
                                      'Gpu1_sync_boost_violation': pa.int32(),
                                      'Gpu2_gpu_temp': pa.int32(),
                                      'Gpu2_thermal_violation': pa.int32(),
                                      'Gpu2_fb_free': pa.int32(),
                                      'Gpu0_power_management_limit': pa.int32(),
                                      'cpu_user': pa.float32(),
                                      'pkts_out': pa.float32(),
                                      'Gpu1_retired_pages_pending': pa.int32(),
                                      'Gpu3_retired_pages_dbe': pa.int32(),
                                      'Gpu3_total_energy_consumption': pa.float64(),
                                      'load_fifteen': pa.float32(),
                                      'Gpu0_pstate': pa.int32(),
                                      'Gpu0_mem_copy_utilization': pa.int32(),
                                      'Gpu2_ecc_sbe_volatile_total': pa.int32(),
                                      'Gpu0_ecc_dbe_volatile_total': pa.int32(),
                                      'Gpu2_nvlink_flit_crc_error_count_total': pa.int32(),
                                      'Gpu2_retired_pages_sbe': pa.int32(),
                                      'Gpu1_sm_app_clock': pa.int32(),
                                      'Gpu3_ecc_dbe_aggregate_total': pa.int32(),
                                      'bytes_out': pa.float32(),
                                      'Gpu0_power_violation': pa.int32(),
                                      'Gpu3_power_violation': pa.int32(),
                                      'Gpu3_fb_total': pa.int32(),
                                      'Gpu3_reliability_violation': pa.int32(),
                                      'Gpu0_nvlink_replay_error_count_total': pa.int32(),
                                      'swap_free': pa.int32(),
                                      'Gpu3_nvlink_replay_error_count_total': pa.int32(),
                                      'pkts_in': pa.float32(),
                                      'Gpu2_gpu_util_samples': pa.int32(),
                                      'Gpu3_ecc_dbe_volatile_total': pa.int32(),
                                      'Gpu2_memory_temp': pa.int32(),
                                      'cpu_nice': pa.float32(),
                                      'Gpu0_nvlink_data_crc_error_count_total': pa.int32(),
                                      'Gpu1_power_usage': pa.float32(),
                                      'Gpu3_sync_boost_violation': pa.int32(),
                                      'Gpu0_thermal_violation': pa.float32(),
                                      'load_one': pa.float32()}
        
        self.dict_cols_per_metric = {'Gpu2_fb_used': ['node'],
                                     'Gpu3_power_management_limit': ['node'],
                                     'Gpu1_ecc_sbe_aggregate_total': ['node'],
                                     'Gpu3_gpu_utilization': ['node'],
                                     'Gpu3_sm_app_clock': ['node'],
                                     'Gpu1_retired_pages_sbe': ['node'],
                                     'Gpu0_power_usage': ['node'],
                                     'cpu_wio': ['node'],
                                     'Gpu0_board_limit_violation': ['node'],
                                     'Gpu2_retired_pages_pending': ['node'],
                                     'Gpu1_total_energy_consumption': ['node'],
                                     'Gpu2_reliability_violation': ['node'],
                                     'Gpu1_nvlink_replay_error_count_total': ['node'],
                                     'Gpu0_ecc_sbe_volatile_total': ['node'],
                                     'Gpu0_gpu_temp': ['node'],
                                     'machine_type': ['node', 'value'],
                                     'disk_free': ['node'],
                                     'Gpu3_gpu_temp': ['node'],
                                     'Gpu1_fb_total': ['node'],
                                     'Gpu0_nvlink_flit_crc_error_count_total': ['node'],
                                     'Gpu2_current_clock_throttle_reasons': ['node'],
                                     'Gpu1_board_limit_violation': ['node'],
                                     'Gpu0_nvlink_bandwidth_total': ['node'],
                                     'Gpu0_reliability_violation': ['node'],
                                     'Gpu0_retired_pages_sbe': ['node'],
                                     'Gpu3_mem_copy_utilization': ['node'],
                                     'Gpu3_pstate': ['node'],
                                     'Gpu2_board_limit_violation': ['node'],
                                     'Gpu0_current_clock_throttle_reasons': ['node'],
                                     'Gpu0_sm_clock': ['node'],
                                     'Gpu3_low_util_violation': ['node'],
                                     'Gpu3_nvlink_recovery_error_count_total': ['node'],
                                     'Gpu2_mem_app_clock': ['node'],
                                     'Gpu1_gpu_util_samples': ['node'],
                                     'Gpu2_nvlink_bandwidth_total': ['node'],
                                     'Gpu1_pstate': ['node'],
                                     'mem_buffers': ['node'],
                                     'Gpu3_nvlink_bandwidth_total': ['node'],
                                     'Gpu1_retired_pages_dbe': ['node'],
                                     'Gpu1_nvlink_recovery_error_count_total': ['node'],
                                     'Gpu0_total_energy_consumption': ['node'],
                                     'proc_run': ['node'],
                                     'Gpu2_low_util_violation': ['node'],
                                     'Gpu2_ecc_sbe_aggregate_total': ['node'],
                                     'mem_total': ['node'],
                                     'Gpu1_memory_temp': ['node'],
                                     'Gpu0_mem_app_clock': ['node'],
                                     'Gpu3_nvlink_flit_crc_error_count_total': ['node'],
                                     'Gpu1_current_clock_throttle_reasons': ['node'],
                                     'bytes_in': ['node'],
                                     'Gpu1_nvlink_flit_crc_error_count_total': ['node'],
                                     'Gpu2_sync_boost_violation': ['node'],
                                     'Gpu2_ecc_dbe_aggregate_total': ['node'],
                                     'cpu_steal': ['node'],
                                     'Gpu1_fb_free': ['node'],
                                     'proc_total': ['node'],
                                     'Gpu1_ecc_sbe_volatile_total': ['node'],
                                     'Gpu0_ecc_sbe_aggregate_total': ['node'],
                                     'Gpu1_gpu_utilization': ['node'],
                                     'Gpu1_power_violation': ['node'],
                                     'Gpu0_ecc_dbe_aggregate_total': ['node'],
                                     'Gpu0_nvlink_recovery_error_count_total': ['node'],
                                     'Gpu3_gpu_util_samples': ['node'],
                                     'Gpu2_nvlink_recovery_error_count_total': ['node'],
                                     'Gpu1_memory_clock': ['node'],
                                     'Gpu0_xid_errors': ['node'],
                                     'Gpu1_gpu_temp': ['node'],
                                     'Gpu0_retired_pages_dbe': ['node'],
                                     'Gpu3_fb_used': ['node'],
                                     'Gpu3_memory_temp': ['node'],
                                     'Gpu1_mem_app_clock': ['node'],
                                     'Gpu2_mem_copy_utilization': ['node'],
                                     'Gpu0_memory_clock': ['node'],
                                     'Gpu0_sync_boost_violation': ['node'],
                                     'Gpu3_board_limit_violation': ['node'],
                                     'Gpu1_ecc_dbe_aggregate_total': ['node'],
                                     'cpu_speed': ['node'],
                                     'Gpu0_memory_temp': ['node'],
                                     'Gpu3_power_usage': ['node'],
                                     'Gpu3_thermal_violation': ['node'],
                                     'Gpu0_fb_free': ['node'],
                                     'Gpu0_gpu_util_samples': ['node'],
                                     'mem_shared': ['node'],
                                     'Gpu0_fb_total': ['node'],
                                     'Gpu3_current_clock_throttle_reasons': ['node'],
                                     'Gpu1_nvlink_bandwidth_total': ['node'],
                                     'Gpu0_sm_app_clock': ['node'],
                                     'Gpu1_fb_used': ['node'],
                                     'Gpu2_nvlink_replay_error_count_total': ['node'],
                                     'Gpu3_ecc_sbe_volatile_total': ['node'],
                                     'gexec': ['node'],
                                     'Gpu1_mem_copy_utilization': ['node'],
                                     'Gpu3_ecc_sbe_aggregate_total': ['node'],
                                     'cpu_idle': ['node'],
                                     'Gpu2_retired_pages_dbe': ['node'],
                                     'Gpu2_total_energy_consumption': ['node'],
                                     'Gpu1_sm_clock': ['node'],
                                     'os_name': ['node', 'value'],
                                     'Gpu3_retired_pages_sbe': ['node'],
                                     'Gpu2_power_violation': ['node'],
                                     'cpu_num': ['node'],
                                     'cpu_system': ['node'],
                                     'Gpu0_retired_pages_pending': ['node'],
                                     'load_five': ['node'],
                                     'Gpu1_nvlink_data_crc_error_count_total': ['node'],
                                     'Gpu1_low_util_violation': ['node'],
                                     'Gpu2_gpu_utilization': ['node'],
                                     'Gpu2_ecc_dbe_volatile_total': ['node'],
                                     'boottime': ['node'],
                                     'disk_total': ['node'],
                                     'Gpu2_power_usage': ['node'],
                                     'swap_total': ['node'],
                                     'Gpu3_nvlink_data_crc_error_count_total': ['node'],
                                     'Gpu0_gpu_utilization': ['node'],
                                     'Gpu3_fb_free': ['node'],
                                     'Gpu0_fb_used': ['node'],
                                     'Gpu2_xid_errors': ['node'],
                                     'Gpu1_ecc_dbe_volatile_total': ['node'],
                                     'cpu_aidle': ['node'],
                                     'mem_free': ['node'],
                                     'Gpu2_memory_clock': ['node'],
                                     'Gpu3_xid_errors': ['node'],
                                     'mem_cached': ['node'],
                                     'Gpu2_nvlink_data_crc_error_count_total': ['node'],
                                     'Gpu2_sm_clock': ['node'],
                                     'Gpu3_mem_app_clock': ['node'],
                                     'part_max_used': ['node'],
                                     'Gpu1_power_management_limit': ['node'],
                                     'Gpu3_sm_clock': ['node'],
                                     'Gpu3_retired_pages_pending': ['node'],
                                     'Gpu2_pstate': ['node'],
                                     'Gpu1_thermal_violation': ['node'],
                                     'os_release': ['node', 'value'],
                                     'Gpu2_power_management_limit': ['node'],
                                     'Gpu0_low_util_violation': ['node'],
                                     'Gpu1_xid_errors': ['node'],
                                     'Gpu2_sm_app_clock': ['node'],
                                     'Gpu3_memory_clock': ['node'],
                                     'Gpu2_fb_total': ['node'],
                                     'Gpu1_reliability_violation': ['node'],
                                     'Gpu1_sync_boost_violation': ['node'],
                                     'Gpu2_gpu_temp': ['node'],
                                     'Gpu2_thermal_violation': ['node'],
                                     'Gpu2_fb_free': ['node'],
                                     'Gpu0_power_management_limit': ['node'],
                                     'cpu_user': ['node'],
                                     'pkts_out': ['node'],
                                     'Gpu1_retired_pages_pending': ['node'],
                                     'Gpu3_retired_pages_dbe': ['node'],
                                     'Gpu3_total_energy_consumption': ['node'],
                                     'load_fifteen': ['node'],
                                     'Gpu0_pstate': ['node'],
                                     'Gpu0_mem_copy_utilization': ['node'],
                                     'Gpu2_ecc_sbe_volatile_total': ['node'],
                                     'Gpu0_ecc_dbe_volatile_total': ['node'],
                                     'Gpu2_nvlink_flit_crc_error_count_total': ['node'],
                                     'Gpu2_retired_pages_sbe': ['node'],
                                     'Gpu1_sm_app_clock': ['node'],
                                     'Gpu3_ecc_dbe_aggregate_total': ['node'],
                                     'bytes_out': ['node'],
                                     'Gpu0_power_violation': ['node'],
                                     'Gpu3_power_violation': ['node'],
                                     'Gpu3_fb_total': ['node'],
                                     'Gpu3_reliability_violation': ['node'],
                                     'Gpu0_nvlink_replay_error_count_total': ['node'],
                                     'swap_free': ['node'],
                                     'Gpu3_nvlink_replay_error_count_total': ['node'],
                                     'pkts_in': ['node'],
                                     'Gpu2_gpu_util_samples': ['node'],
                                     'Gpu3_ecc_dbe_volatile_total': ['node'],
                                     'Gpu2_memory_temp': ['node'],
                                     'cpu_nice': ['node'],
                                     'Gpu0_nvlink_data_crc_error_count_total': ['node'],
                                     'Gpu1_power_usage': ['node'],
                                     'Gpu3_sync_boost_violation': ['node'],
                                     'Gpu0_thermal_violation': ['node'],
                                     'load_one': ['node']}
    
    def get_schema_in(self, metric_name):
        schema_in = pa.schema([('', pa.int64()),
                               ('timestamp', pa.timestamp('ms', tz='UTC')),
                               ("value", self.value_type_per_metric[metric_name]), 
                               ('name', pa.string()),
                               ('chnl', pa.string()),
                               ('cluster', pa.string()),
                               ('gcluster', pa.string()),
                               ('group', pa.string()),
                               ('node', pa.string()),
                               ('org', pa.string()),
                               ('plugin', pa.string()),
                               ('rack', pa.int64()),
                               ('slot', pa.int64()),
                               ('units', pa.string())])

        return schema_in 

    def get_schema_out(self, metric_name):
        schema_out = pa.schema([("plugin", pa.string()),
                                ("metric", pa.string()),
                                ("year_month", pa.string()),
                                ("timestamp", pa.timestamp('ms', tz='UTC')),
                                ("value", self.value_type_per_metric[metric_name]), 
                                ("node", pa.string())])
        return schema_out

    def get_preprocessing_step1(self):
        def preprocessing(batches, schema_out):
            for batch in batches:

                metric = batch['name']

                # making plugin array, as in some raw CSVs files the tag was already filtered
                batch_size = len(metric)
                plugin = pa.array(['ganglia_pub']*batch_size)

                # extracting month and year
                year_month = pc.strftime(batch['timestamp'], '%y-%m')

                arrays = [plugin, metric, year_month, batch['timestamp'], batch['value'], batch['node']]
                batch = pa.RecordBatch.from_arrays(arrays, schema=schema_out)
            
                yield batch

        return preprocessing

    def get_preprocessing_step2(self):
        """Parquet to Parquet."""
        def preprocessing(batches, metric_name, schema_out, anonymization_dictionaries):
            for batch in batches:

                
                batch_size = len(batch)
                metric = pa.array([metric_name]*batch_size, type=pa.string())
                plugin = pa.array(['ganglia_pub']*batch_size)

                # extracting month and year
                year_month = pc.strftime(batch['timestamp'], '%y-%m')
                
                # anonymize nodes
                # remove ".m100.cineca.it" when present
                node = batch['node'].to_pandas(). \
                       apply(lambda x: x if pd.isnull(x) else x.split('.m100.cineca.it')[0]). \
                       apply(lambda x: str(anonymization_dictionaries['node'][x]))

                # creating new batch from single arrays
                arrays = [plugin, metric, year_month, batch['timestamp'], batch['value'], node]
                batch = pa.RecordBatch.from_arrays(arrays, schema=schema_out)
            
                yield batch

        return preprocessing
